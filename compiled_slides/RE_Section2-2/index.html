<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Introduction to Reverse Engineering</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="asm.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1500"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="windows-internals-primer">Windows Internals Primer</h1></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="objectives">Objectives</h1><ul><li>Understand basic facts relating to the Windows API</li><li>Understand HANDLEs and some of their uses</li><li>Understand the Windows Object Manager, and how it relates to various kernel objects</li><li>Understand the general memory layout and composition of a Windows process</li><li>Understand, at a basic level, the purpose of some common kernel object types</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="windows-api-basics">Windows API Basics</h1><ul><li>The Windows API is broken into a series of layers</li><li>Win32 API provides the bulk of the "documented" functionality provided to developers</li><li>The Windows Native API exists a layer down from the Win32 API, and underpins its functionality</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="the-win32-api">The Win32 API</h1><ul><li>Covers the bulk of the documented APIs provided to developers</li><li>Spans a number of DLLs and libraries</li><li><dl><dt>General Purpose Methods</dt><dd><ul><li>Many provided via Kernel32.dll</li><li>Post Windows XP, implementation provided in KERNELBASE.dll</li></ul></dd></dl></li><li><dl><dt>Other DLLs of Note</dt><dd><ul><li>User32.dll - Provides Most GUI methods</li><li>Ws2_32.dll - Networking Functions</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="ascii-vs-unicode">ASCII vs Unicode</h1><ul><li><dl><dt>A large number of Win32 methods are provided in two forms:</dt><dd><ul><li>ASCII</li><li>Wide character (UTF-16le)</li></ul></dd></dl></li><li>In these cases, two versions are exported from the parent DLL.</li></ul><p>Example:</p><ul><li><dl><dt>Kernel32 exports two versions of CreateFile</dt><dd><ul><li>CreateFileA - Accepts an ASCII file path (char*)</li><li>CreateFileW - Accepts a wide char file path (wchar_t*)</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="the-windows-native-api">The Windows Native API</h1><ul><li>Underpins the Win32 API Methods</li><li>Largely undocumented</li><li>Exposes some additional functionality not available via Win32 methods</li><li>Primarily exported from ntdll.dll</li></ul></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="native-api-methods-and-references">Native API Methods and References</h1><ul><li>Some methods documented via the Windows Driver Kit docs</li><li>Nt* and Zw* Methods are the same in user mode (though not in kernel mode)</li><li>See also: Windows NT/2000 Native API Reference by Gary Nebbett</li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="unicode-and-the-native-api">Unicode and the Native API</h1><ul><li>Almost all native API methods exclusively use wide-character strings</li><li>UNICODE_STRING structure is used throughout Native API and Kernel API</li><li>UNICODE_STRINGs are byte counted, and not always NULL terminated</li></ul></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="wow64">WoW64</h1><ul><li><dl><dt>Stands for Windows on Windows 64</dt><dd><ul><li>Set of facilities for managing 32 bit programs on 64 bit systems</li><li>64 bit system path:  C:WindowsSystem32</li><li>32 bit emulated path: C:WindowsSysWOW64</li></ul></dd></dl></li><li>Registry Entries also redirected: wow6432node</li></ul></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="differences-in-entry-points">Differences in Entry Points</h1><ul><li>Console Applications:</li></ul><pre class="highlight code c"><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="cm">/* WCHAR == wchar_t */</span>
<span class="kt">int</span> <span class="n">wmain</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">WCHAR</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span></pre><ul><li>GUI Applications:</li></ul><pre class="highlight code c"><span class="cm">/**
*  LPWSTR == wchar_t*
*  LPSTR == char*
*  HINSTANCE == HANDLE
*/</span>
<span class="kt">int</span> <span class="n">CALLBACK</span> <span class="n">WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInst</span><span class="p">,</span>
                     <span class="n">HINSTANCE</span> <span class="n">hPrev</span><span class="p">,</span>
                     <span class="n">LPSTR</span>     <span class="n">lpCmdLine</span><span class="p">,</span>
                     <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">CALLBACK</span> <span class="n">wWinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInst</span><span class="p">,</span>
                      <span class="n">HINSTANCE</span> <span class="n">hPrev</span><span class="p">,</span>
                      <span class="n">LPWSTR</span>     <span class="n">lpCmdLine</span><span class="p">,</span>
                      <span class="kt">int</span>       <span class="n">nCmdShow</span><span class="p">)</span></pre></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="id1">Differences in Entry Points</h1><ul><li>DLLs</li></ul><pre class="highlight code c"><span class="cm">/* LPVOID == void* */</span>
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="n">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInst</span><span class="p">,</span>
                    <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span>
                    <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span></pre><ul><li>Drivers</li></ul><pre class="highlight code c"><span class="n">NTSTATUS</span> <span class="n">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDrv</span><span class="p">,</span>
                     <span class="n">PUNICODE_STRING</span> <span class="n">pRegPath</span><span class="p">)</span></pre></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="the-windows-object-manager">The Windows Object Manager</h1><ul><li>Kernel-mode entity responsible for managing kernel objects</li><li>Maintains a reference (and HANDLE) count of each object</li><li>Handles garbage collection of objects when all consumers have stopped using resources</li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="why-does-this-matter">Why does this matter?</h1><ul><li>All of those kernel objects map to resources in use by various processes</li><li>From an RE perspective, this (potentially) gives a great deal of insight into what sort of things a process might be doing</li><li>Resources are (relatively) easily enumerable via sysinternals tools (e.g., Process Explorer)</li></ul><div class="notes"><p>perform procexp demo -&gt; Show lower pane to make kernel objects used by process visible</p></div></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="what-s-in-a-handle">What's in a HANDLE?</h1><ul><li>Intentionally opaque structure</li><li>Pointer-size (though typically not really a pointer)</li><li>Actually represents an offset into a process's HANDLE table</li></ul></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="handles-cont-d">HANDLEs (cont'd)</h1><ul><li>HANDLE table provides a simple way for the Object Manager to keep track of process resources</li><li>Each object stored in the table essentially brokers access to various kernel objects (subject to permissions, of course)</li><li><dl><dt>Some Examples of kernel objects:</dt><dd><ul><li>A HANDLE to a MUTEX</li><li>A File Object, representing a file (or device) currently opened by the process</li><li>A HANDLE to another process</li><li>...</li></ul></dd></dl></li><li>The HANDLE table of a given process can be dumped via Windbg using the !handle extension</li></ul><div class="notes"><p>Demo: dump the handles of a process using Windbg</p></div></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="handles-and-pseudo-handles">HANDLEs and pseudo-HANDLEs</h1><ul><li>Pseudo-HANDLEs are similar (at first glance) to HANDLEs, in that they are opaque (and often typedef'd to HANDLE), but do not have all of the same properties</li><li>CloseHandle typically cannot be called on a pseudo-HANDLE</li><li><dl><dt>Some examples include:</dt><dd><ul><li>The context HANDLE returned by FindFirstFile(A|W)</li><li>The return value of GetModuleHandle() (which is actually the base address of the requested module)</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="windows-kernel-objects">Windows Kernel Objects</h1><ul><li>Variety of object types</li><li>Can be viewed via Sysinternals tools/Windbg</li><li>Can be named or unnamed</li><li>Various namespaces exist (\??\, \Devices, etc.)</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="kernel-object-types">Kernel Object Types</h1><p>Some common types that can be observed:</p><ul><li><dl><dt>Sections</dt><dd><ul><li>Represent a block of memory</li><li>Can be regularly allocated, memory mapped file, etc</li></ul></dd></dl></li><li><dl><dt>Ports</dt><dd><ul><li>Often represent (A)LPC Communication mechanisms</li><li>Used for IPC</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="kernel-object-types-cont-d">Kernel Object Types (cont'd)</h1><ul><li><dl><dt>Mutants</dt><dd><ul><li>Another name for MUTEXes</li><li>As kernel objects, can provide cross-process synchronization</li></ul></dd></dl></li><li><dl><dt>Events</dt><dd><ul><li>Another synchronization/signaling mechanism</li></ul></dd></dl></li><li><dl><dt>File Objects</dt><dd><ul><li>Represents an open instance of another object, such as a file, directory, or device</li></ul></dd></dl></li><li>Many others</li></ul></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="process-bookkeeping">Process Bookkeeping</h1><ul><li>Much of the usermode process bookkeeping information is available via a number of undocumented/partially documented (but easily reachable) structures</li><li>The Thread Information Block (TIB) and Thread Environment Block (TEB) exist on a per-thread basis</li><li>The Process Environment Block (PEB) exists per process</li></ul></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="tib-and-teb">TIB and TEB</h1><ul><li>The TIB is actually a subset of the TEB (the first field, in fact!)</li><li>Lots of per-thread information is tracked here, to include the last error value (accessed via (Get|Set)LastError), and the Thread Local Storage table (We'll talk more about TLS when we discuss executable file formats)</li><li>Useful parts of the TIB and the TEB</li><li>(windbg) !teb</li><li>(windbg) dt -r nt!_TEB</li></ul></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="peb">PEB</h1><ul><li>Containts quite a bit of useful information, including links to the list of loaded DLLs, the debug port, and other various resources</li><li>Useful parts of the PEB</li><li>(windbg) !peb</li><li>(windbg) dt nt!_PEB</li></ul></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="the-peb-and-changes">The PEB and Changes</h1><blockquote><ul><li>Some variations to the structure, but many parts remain the same</li><li>Good writup of the PEB's makeup, both current and historical:</li></ul><p><a href="http://blog.rewolf.pl/blog/?p=573">http://blog.rewolf.pl/blog/?p=573</a></p></blockquote></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>