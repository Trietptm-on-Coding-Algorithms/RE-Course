<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Introduction to Reverse Engineering</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="asm.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1500"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="loading-and-linking">Loading and Linking</h1></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="objectives">Objectives</h1><ul><li>Understand, at a high level, the process of loading and running executables</li><li>Understand some of the actions performed by the C Runtime (CRT) during initialization</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="what-happens-at-load-time">What Happens at Load Time</h1><ul><li>File gets mapped into memory</li><li>(PE) Relocations get fixed up</li><li>Imports get resolved</li><li>Entry point gets called (if applicable)</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="dynamic-libraries">Dynamic Libraries</h1><ul><li><dl><dt>Dynamic Link Libraries (DLLs) and Shared Objects (SOs) typically provide shared functionality</dt><dd><ul><li>glibc (*nix)</li><li>Kernel32/KERNELBASE/ntdll (Windows)</li></ul></dd></dl></li><li>Dynamic (NOT runtime) linking implies a dependency</li><li>Exported functions from DLLs and SOs generate import table entries</li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="entry-points">Entry Points</h1><ul><li><dl><dt>Typical exported entry points may not necessarily be called "main"</dt><dd><ul><li>_start</li><li>_DllMainCRTStartup/_mainCRTStartup</li></ul></dd></dl></li><li>Other methods - such as TLS callbacks (Windows) may also be invoked</li></ul></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="import-resolution">Import Resolution</h1><ul><li>Import table entries are resolved</li><li>Copies of required libs provided to process</li><li>Addresses of loaded functions added to table</li><li>Loading fails if imports cannot be satisfied</li></ul></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="some-additional-points">Some Additional Points</h1><ul><li><dl><dt>Often copies of mappings are provided for common libs</dt><dd><ul><li>Mappings provided as Copy On Write</li><li>Reduces overhead of process creation/loading process</li></ul></dd></dl></li><li>Other steps may be accomplished, depending on platform</li><li>Runtime linking allows dynamic checks to see if imports exist or not, without preventing loading</li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="compilers-optimizations">Compilers - Optimizations</h1></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="id1">Objectives</h1><ul><li>Understand and identify a number of optimizations performed by compilers</li></ul></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="jump-tables">Jump Tables</h1><ul><li>Often produced for switch statements</li><li>A table of offsets to jump to based on the result of a comparison</li><li>Used as an optimization to avoid lots of conditional branches and comparisons</li></ul></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="jump-tables-example-c">Jump Tables - Example C</h1><pre class="highlight code c"><span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="mi">10</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"tmp1.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Allocation failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">Cleanup</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">GetCommandLineA</span><span class="p">());</span>
        <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">20</span><span class="o">:</span>
        <span class="n">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
                <span class="s">"Second option selected!"</span><span class="p">,</span>
                <span class="s">"TITLE"</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">30</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">"tmp2.txt"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Opening tmp2 failed!"</span><span class="p">);</span>
                <span class="k">goto</span> <span class="n">Cleanup</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">"%d:%s"</span><span class="p">,</span> <span class="n">__COUNTER__</span><span class="p">,</span> <span class="n">__TIMESTAMP__</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">40</span><span class="o">:</span>
<span class="k">case</span> <span class="mi">50</span><span class="o">:</span>
        <span class="n">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Last option selected!"</span><span class="p">,</span>
                                <span class="s">"ANOTHER TITLE"</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
<span class="k">default</span><span class="o">:</span>
        <span class="n">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Unknown option selected!"</span><span class="p">,</span>
                        <span class="s">"That didn't work!"</span><span class="p">,</span> <span class="n">MB_ICONERROR</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1 flex-image" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="jump-tables-example-asm">Jump Tables - Example ASM</h1><img src="./img/jmp_table_p1.png"></img></div><div class="step step-level-1 flex-image" step="12" data-x="20100" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-y="0" data-z="0"><h1 id="jump-tables-example-asm-cont-d">Jump Tables - Example ASM (Cont'd)</h1><img src="./img/jmp_table_p2.png"></img></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22600" data-y="0" data-z="0"><h1 id="function-inlining">Function Inlining</h1><ul><li>Function code is copied inline each time it is used</li><li><dl><dt>Reduces overhead of function calls at cost of space</dt><dd><ul><li>Code is copied rather than reused, resulting in bigger binary</li><li>No additional overhead for calls</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25100" data-y="0" data-z="0"><h1 id="function-inlining-example-c">Function Inlining - Example C</h1><pre class="highlight code c"><span class="n">BOOL</span> <span class="kr">__forceinline</span> <span class="nf">func1</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">?</span> <span class="nl">FALSE</span> <span class="p">:</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>

  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">func1</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">?</span> <span class="s">"Yes"</span> <span class="o">:</span> <span class="s">"No"</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Is the cmdline param a multiple of 10? %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
    <span class="n">tmp</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div><div class="step step-level-1 mid-image" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27600" data-y="0" data-z="0"><h1 id="function-inlining-example-asm">Function Inlining - Example ASM</h1><img src="./img/inlining_p1.png"></img></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30100" data-y="0" data-z="0"><h1 id="frame-pointer-optimization-omission">Frame Pointer Optimization/Omission</h1><ul><li>Tells the compiler not to use the base pointer (EBP/RBP) as normal</li><li>Frees it up to be used as another general purpose register</li><li>Can make debugging more difficult (harder to reason about call stack)</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32600" data-y="0" data-z="0"><h1 id="loop-unrolling">Loop Unrolling</h1><ul><li>Instructions within loop body are copied for each iteration</li><li>Larger resulting binary size, but without overhead of branching</li></ul></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35100" data-y="0" data-z="0"><h1 id="a-tale-of-duff-s-device">A Tale of Duff's Device</h1><ul><li>Concept code courtesy of Tom Duff, 1983</li><li>Good case study, though likely no longer significantly performant with modern compilers</li><li>Original requirement involved copying 16-bit units from an array to a memory-mapped register</li><li>Naive approach suffered from performance issues</li><li>Thus, unrolling to blocks of 8 yielded significant improvements</li></ul></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="37600" data-y="0" data-z="0"><h1 id="duff-s-device-initial">Duff's Device - Initial</h1><pre class="highlight code c"><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="k">register</span> <span class="kt">short</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
<span class="k">register</span> <span class="n">count</span><span class="p">;</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">n</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">do</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
    <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40100" data-y="0" data-z="0"><h1 id="initial-effort-issues">Initial Effort - Issues</h1><ul><li>This approach works - with one small problem</li><li>Always assumes that the copy target is evenly divisble by 8</li></ul></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="42600" data-y="0" data-z="0"><h1 id="duff-s-device-the-solution">Duff's Device - The Solution</h1><pre class="highlight code c"><span class="n">send</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="k">register</span> <span class="kt">short</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">;</span>
<span class="k">register</span> <span class="n">count</span><span class="p">;</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">do</span> <span class="p">{</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">7</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">6</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">5</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">4</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">3</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">2</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
<span class="k">case</span> <span class="mi">1</span><span class="o">:</span>      <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span></pre></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="45100" data-y="0" data-z="0"><h1 id="structured-exception-handling-seh">Structured Exception Handling (SEH)</h1><ul><li>Provides a mechanism for managing exceptional conditions via C</li><li>Has some semantic differences from C++ style exception handling</li><li><dl><dt>Can allow recovery from events such as:</dt><dd><ul><li>Bad memory accesses (e.g., segmentation faults)</li><li>Divide by zero errors</li><li>...</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="47600" data-y="0" data-z="0"><h1 id="seh-examples">SEH Examples</h1><pre class="highlight code c"><span class="kt">char</span><span class="o">*</span> <span class="n">badptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="kr">__try</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"We're trying to do some stuff here...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Bad memory access: %c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">badptr</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">__except</span> <span class="p">(</span><span class="n">EXCEPTION_EXECUTE_HANDLER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"An exception occurred! 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetExceptionCode</span><span class="p">());</span>
<span class="p">}</span></pre><p>Output:</p><pre class="highlight code">We're trying to do some stuff here...
An exception occurred! 0xc0000005</pre></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="50100" data-y="0" data-z="0"><h1 id="seh-details">SEH Details</h1><p>The stack frame disassembly:</p><img src="./img/SEH_p1.png"></img></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="52600" data-y="0" data-z="0"><h1 id="seh-details-cont-d">SEH Details (cont'd)</h1><p>SEH Thunk (w/ jump to supporting method):</p><img src="./img/SEH_thunk.png"></img></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="55100" data-y="0" data-z="0"><h1 id="id2">SEH Details (cont'd)</h1><p>Exception Handler:</p><img src="./img/SEH_handler.png"></img></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="57600" data-y="0" data-z="0"><h1 id="id3">SEH Details (cont'd)</h1><ul><li>Stack frame layout is much further complicated with this construct</li><li>Implementation actually varies a bit between VS compiler versions</li><li>Newer SEH versions (such as the one we see here) provide additional buffer overrun protections</li></ul></div><div class="step step-level-1 flex-image" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="60100" data-y="0" data-z="0"><h1 id="seh-stack-layout">SEH Stack Layout</h1><img src="./img/igor1_seh4_stack_layout.gif"></img><p>Image Credit: igorsk - <a href="http://www.openrce.org/articles/full_view/21">http://www.openrce.org/articles/full_view/21</a></p></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>