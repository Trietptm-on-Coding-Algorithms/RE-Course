<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Introduction to Reverse Engineering</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="asm.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress" data-transition-duration="1500"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="executable-file-formats">Executable File Formats</h1></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="objectives">Objectives</h1><ul><li><dl><dt>Understand and Identify the major components of executable file formats</dt><dd><ul><li>PE</li><li>ELF</li><li>MACH-O</li></ul></dd></dl></li><li>Analyze the composition of provided binaries</li></ul></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="a-tour-of-pe">A Tour of PE</h1></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="portable-executables">Portable Executables</h1><ul><li>Descended from the Common Object File Format (COFF)</li><li>The standard executable file format used by Windows</li><li><dl><dt>Can have many extensions, depending on use case. Common ones include:</dt><dd><ul><li>dll</li><li>exe</li><li>sys</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="pe-concepts">PE Concepts</h1><ul><li>Consist of a variety of structures</li><li><dl><dt>Data addressing within the file typically takes two forms:</dt><dd><ul><li>RVA - Relative Virtual Address - An offset into the file (from the base)</li><li>VA - Virtual Address - An absolute memory address</li></ul></dd></dl></li><li>Lots of good resources for dealing with the file format (though it can be a bit complicated)</li></ul></div><div class="step step-level-1 mid-image" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><img src="./img/pe101.svg"></img><p>Image Credit: corkami wiki - <a href="https://code.google.com/archive/p/corkami">https://code.google.com/archive/p/corkami</a> | <a href="https://creativecommons.org/licenses/by/3.0/us/">https://creativecommons.org/licenses/by/3.0/us/</a></p></div><div class="step step-level-1" step="6" data-y="2000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-z="0"><h1 id="introducing-pefile">Introducing pefile</h1><ul><li>Robust Python library for parsing PE files</li><li>Great support for reading all and updating many sections</li><li>May allow for inspection of binaries with malformed headers that are difficult for other, more complete solutions (e.g., IDA) to handle</li></ul></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="4000" data-z="0"><h1 id="using-pefile">Using pefile</h1><pre class="highlight code python"><span class="kn">import</span> <span class="nn">pefile</span>

<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="s2">"demo.exe"</span><span class="p">)</span></pre></div><div class="step step-level-1 flex-image" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="6000" data-z="0"><h1 id="another-view">Another View</h1><img src="./img/Carrera_PE_vis.png"></img><p>Image Credit: Ero Carrera</p></div><div class="step step-level-1 flex-image" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="8000" data-z="0"><img src="./img/PE_vis_doshdr.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1 windbg" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="10000" data-z="0"><h1 id="dos-header">DOS Header</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DOS_HEADER</span> <span class="p">{</span>      <span class="c1">// DOS .EXE header
</span>    <span class="n">WORD</span>   <span class="n">e_magic</span><span class="p">;</span>                     <span class="c1">// Magic number
</span>    <span class="n">WORD</span>   <span class="n">e_cblp</span><span class="p">;</span>                      <span class="c1">// Bytes on last page of file
</span>    <span class="n">WORD</span>   <span class="n">e_cp</span><span class="p">;</span>                        <span class="c1">// Pages in file
</span>    <span class="n">WORD</span>   <span class="n">e_crlc</span><span class="p">;</span>                      <span class="c1">// Relocations
</span>    <span class="n">WORD</span>   <span class="n">e_cparhdr</span><span class="p">;</span>                   <span class="c1">// Size of header in paragraphs
</span>    <span class="n">WORD</span>   <span class="n">e_minalloc</span><span class="p">;</span>                  <span class="c1">// Minimum extra paragraphs needed
</span>    <span class="n">WORD</span>   <span class="n">e_maxalloc</span><span class="p">;</span>                  <span class="c1">// Maximum extra paragraphs needed
</span>    <span class="n">WORD</span>   <span class="n">e_ss</span><span class="p">;</span>                        <span class="c1">// Initial (relative) SS value
</span>    <span class="n">WORD</span>   <span class="n">e_sp</span><span class="p">;</span>                        <span class="c1">// Initial SP value
</span>    <span class="n">WORD</span>   <span class="n">e_csum</span><span class="p">;</span>                      <span class="c1">// Checksum
</span>    <span class="n">WORD</span>   <span class="n">e_ip</span><span class="p">;</span>                        <span class="c1">// Initial IP value
</span>    <span class="n">WORD</span>   <span class="n">e_cs</span><span class="p">;</span>                        <span class="c1">// Initial (relative) CS value
</span>    <span class="n">WORD</span>   <span class="n">e_lfarlc</span><span class="p">;</span>                    <span class="c1">// File address of relocation table
</span>    <span class="n">WORD</span>   <span class="n">e_ovno</span><span class="p">;</span>                      <span class="c1">// Overlay number
</span>    <span class="n">WORD</span>   <span class="n">e_res</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>                    <span class="c1">// Reserved words
</span>    <span class="n">WORD</span>   <span class="n">e_oemid</span><span class="p">;</span>                     <span class="c1">// OEM identifier (for e_oeminfo)
</span>    <span class="n">WORD</span>   <span class="n">e_oeminfo</span><span class="p">;</span>                   <span class="c1">// OEM information; e_oemid specific
</span>    <span class="n">WORD</span>   <span class="n">e_res2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>                  <span class="c1">// Reserved words
</span>    <span class="n">LONG</span>   <span class="n">e_lfanew</span><span class="p">;</span>                    <span class="c1">// File address of new exe header
</span>  <span class="p">}</span> <span class="n">IMAGE_DOS_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">;</span></pre><p>Defined: winnt.h</p></div><div class="step step-level-1" step="11" data-x="18000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-y="12000" data-z="0"><h1 id="dos-header-useful-fields">DOS Header - Useful Fields</h1><p>The most interesting fields in this header:</p><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DOS_HEADER</span> <span class="p">{</span>  <span class="c1">// DOS .EXE header
</span>    <span class="n">WORD</span>   <span class="n">e_magic</span><span class="p">;</span>                 <span class="c1">// Magic Number
</span>    <span class="c1">// ...
</span>    <span class="n">LONG</span>   <span class="n">e_lfanew</span><span class="p">;</span>               <span class="c1">// The RVA to the PE header
</span>  <span class="p">}</span> <span class="n">IMAGE_DOS_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">;</span></pre></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20000" data-y="14000" data-z="0"><h1 id="dos-header-cont-d">Dos Header (cont'd)</h1><ul><li><dl><dt>e_magic:  The first two bytes of the PE files spell out "MZ", which is there for compatibility reasons</dt><dd><ul><li>Originally the "magic number" for DOS 16-bit executables</li><li>An Old New Thing article talks a bit about historical aspect of this transition: <a href="https://blogs.msdn.microsoft.com/oldnewthing/20060130-00/?p=32483/">https://blogs.msdn.microsoft.com/oldnewthing/20060130-00/?p=32483/</a></li></ul></dd></dl></li><li>e_lfanew: This is the RVA essential to getting us to the next important header (the NT header), which will get us to the rest of the binary.</li></ul></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22000" data-y="16000" data-z="0"><h1 id="pefile-view">pefile view</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pefile</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="s2">"demo.exe"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">DOS_HEADER</span>
<span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_DOS_HEADER</span><span class="p">]</span> <span class="mh">0x0</span> <span class="mh">0x0</span> <span class="n">e_magic</span><span class="p">:</span> <span class="mh">0x5A4D</span> <span class="mh">0x2</span> <span class="mh">0x2</span>
<span class="n">e_cblp</span><span class="p">:</span> <span class="mh">0x90</span> <span class="mh">0x4</span> <span class="mh">0x4</span> <span class="n">e_cp</span><span class="p">:</span> <span class="mh">0x3</span> <span class="mh">0x6</span> <span class="mh">0x6</span> <span class="n">e_crlc</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x8</span> <span class="mh">0x8</span>
<span class="n">e_cparhdr</span><span class="p">:</span> <span class="mh">0x4</span> <span class="mh">0xA</span> <span class="mh">0xA</span> <span class="n">e_minalloc</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0xC</span> <span class="mh">0xC</span>
<span class="n">e_maxalloc</span><span class="p">:</span> <span class="mh">0xFFFF</span> <span class="mh">0xE</span> <span class="mh">0xE</span> <span class="n">e_ss</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x10</span> <span class="mh">0x10</span>
<span class="n">e_sp</span><span class="p">:</span> <span class="mh">0xB8</span> <span class="mh">0x12</span> <span class="mh">0x12</span> <span class="n">e_csum</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x14</span> <span class="mh">0x14</span> <span class="n">e_ip</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x16</span> <span class="mh">0x16</span>
<span class="n">e_cs</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x18</span> <span class="mh">0x18</span> <span class="n">e_lfarlc</span><span class="p">:</span> <span class="mh">0x40</span> <span class="mh">0x1A</span> <span class="mh">0x1A</span>
<span class="n">e_ovno</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x1C</span> <span class="mh">0x1C</span> <span class="n">e_res</span><span class="p">:</span> <span class="mh">0x24</span> <span class="mh">0x24</span>
<span class="n">e_oemid</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x26</span> <span class="mh">0x26</span> <span class="n">e_oeminfo</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x28</span> <span class="mh">0x28</span>
<span class="n">e_res2</span><span class="p">:</span> <span class="mh">0x3C</span> <span class="mh">0x3C</span>
<span class="n">e_lfanew</span><span class="p">:</span> <span class="mh">0xE8</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">hex</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">DOS_HEADER</span><span class="o">.</span><span class="n">e_lfanew</span><span class="p">)</span>
<span class="s1">'0xe8'</span></pre></div><div class="step step-level-1 flex-image" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="18000" data-z="0"><img src="./img/PE_vis_nthdr.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="26000" data-y="20000" data-z="0"><h1 id="nt-header">NT Header</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_NT_HEADERS</span> <span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">Signature</span><span class="p">;</span>
    <span class="n">IMAGE_FILE_HEADER</span> <span class="n">FileHeader</span><span class="p">;</span>
    <span class="n">IMAGE_OPTIONAL_HEADER32</span> <span class="n">OptionalHeader</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_NT_HEADERS32</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_NT_HEADERS32</span><span class="p">;</span></pre><p>Defined: winnt.h</p></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28000" data-y="22000" data-z="0"><h1 id="nt-header-fields">NT Header Fields</h1><ul><li>Signature spells out "PE, 0, 0" 0x00 0x00 0x45 0x50 (little endian)</li><li>File header (discussed more next slide)</li><li>OptionalHeader - Not really that optional!</li></ul></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30000" data-y="24000" data-z="0"><h1 id="nt-header-pefile-view">NT Header pefile View</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">NT_HEADERS</span>
<span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_NT_HEADERS</span><span class="p">]</span> <span class="mh">0xE8</span> <span class="mh">0x0</span> <span class="n">Signature</span><span class="p">:</span> <span class="mh">0x4550</span><span class="o">&gt;</span></pre></div><div class="step step-level-1 flex-image" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="26000" data-z="0"><img src="./img/PE_vis_imgfilehdr.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="34000" data-y="28000" data-z="0"><h1 id="image-file-header">Image File Header</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_FILE_HEADER</span> <span class="p">{</span>
    <span class="n">WORD</span>    <span class="n">Machine</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">NumberOfSections</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">TimeDateStamp</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">PointerToSymbolTable</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">NumberOfSymbols</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">SizeOfOptionalHeader</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">Characteristics</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_FILE_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_FILE_HEADER</span><span class="p">;</span></pre><p>Defined: winnt.h</p></div><div class="step step-level-1 windbg" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36000" data-y="30000" data-z="0"><h1 id="image-file-header-machine">Image File Header - Machine</h1><ul><li>Indicates the architecture the binary was intended to run on</li><li>A number of potential options, defined in winnt.h</li></ul><pre class="highlight code c"><span class="cp">#define IMAGE_FILE_MACHINE_UNKNOWN    0
#define IMAGE_FILE_MACHINE_I386       0x014c  </span><span class="c1">// Intel 386.
</span><span class="cp">#define IMAGE_FILE_MACHINE_R3000      0x0162  </span><span class="c1">// MIPS le 0x160 big-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_R4000      0x0166  </span><span class="c1">// MIPS little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_R10000     0x0168  </span><span class="c1">// MIPS little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_WCEMIPSV2  0x0169  </span><span class="c1">// MIPS little-endian WCE v2
</span><span class="cp">#define IMAGE_FILE_MACHINE_ALPHA      0x0184  </span><span class="c1">// Alpha_AXP
</span><span class="cp">#define IMAGE_FILE_MACHINE_SH3        0x01a2  </span><span class="c1">// SH3 little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_SH3DSP     0x01a3
#define IMAGE_FILE_MACHINE_SH3E       0x01a4  </span><span class="c1">// SH3E little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_SH4        0x01a6  </span><span class="c1">// SH4 little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_SH5        0x01a8  </span><span class="c1">// SH5
</span><span class="cp">#define IMAGE_FILE_MACHINE_ARM        0x01c0  </span><span class="c1">// ARM Little-Endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_THUMB      0x01c2  </span><span class="c1">// ARM Thumb/Thumb-2 LE
</span><span class="cp">#define IMAGE_FILE_MACHINE_ARMNT      0x01c4  </span><span class="c1">// ARM Thumb-2 Little-Endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_AM33       0x01d3
#define IMAGE_FILE_MACHINE_POWERPC    0x01F0  </span><span class="c1">// IBM PowerPC Little-Endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_POWERPCFP  0x01f1
#define IMAGE_FILE_MACHINE_IA64       0x0200  </span><span class="c1">// Intel 64
</span><span class="cp">#define IMAGE_FILE_MACHINE_MIPS16     0x0266  </span><span class="c1">// MIPS
</span><span class="cp">#define IMAGE_FILE_MACHINE_ALPHA64    0x0284  </span><span class="c1">// ALPHA64
</span><span class="cp">#define IMAGE_FILE_MACHINE_MIPSFPU    0x0366  </span><span class="c1">// MIPS
</span><span class="cp">#define IMAGE_FILE_MACHINE_MIPSFPU16  0x0466  </span><span class="c1">// MIPS
</span><span class="cp">#define IMAGE_FILE_MACHINE_AXP64      IMAGE_FILE_MACHINE_ALPHA64
#define IMAGE_FILE_MACHINE_TRICORE    0x0520  </span><span class="c1">// Infineon
</span><span class="cp">#define IMAGE_FILE_MACHINE_CEF        0x0CEF
#define IMAGE_FILE_MACHINE_EBC        0x0EBC  </span><span class="c1">// EFI Byte Code
</span><span class="cp">#define IMAGE_FILE_MACHINE_AMD64      0x8664  </span><span class="c1">// AMD64 (K8)
</span><span class="cp">#define IMAGE_FILE_MACHINE_M32R       0x9041  </span><span class="c1">// M32R little-endian
</span><span class="cp">#define IMAGE_FILE_MACHINE_CEE        0xC0EE</span></pre></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38000" data-y="32000" data-z="0"><h1 id="image-file-header-numberofsections">Image File Header - NumberOfSections</h1><p>The number of IMAGE_SECTION_HEADERs that will follow this header</p></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="34000" data-z="0"><h1 id="image-file-header-timedatestamp">Image File Header - TimeDateStamp</h1><ul><li>UNIX-style timestamp</li><li>Number of seconds since epoc (Jan 1st, 1970)</li></ul></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="42000" data-y="36000" data-z="0"><h1 id="image-file-header-pointertosymboltable-numberofsymbols">Image File Header - PointerToSymbolTable / NumberOfSymbols</h1><ul><li>Historical use was to indicate location of Debugging Symbols</li><li>Now typically those are packaged in a separate pdb file, and thus these fields are not often used anymore</li></ul></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="44000" data-y="38000" data-z="0"><h1 id="image-file-header-characteristics">Image File Header - Characteristics</h1><ul><li>Flags field used to indicate various information about the binary and how it should be handled</li><li>Information about relocations, whether or not it is executable or a DLL, etc is set here</li><li>A number of other potential attributes is specified in winnt.h (typos from header file included below :P ):</li></ul></div><div class="step step-level-1 windbg" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="46000" data-y="40000" data-z="0"><h1 id="image-file-header-characteristics-cont-d">Image File Header Characteristics (Cont'd)</h1><pre class="highlight code c"><span class="c1">// Relocation info stripped from file.
</span><span class="cp">#define IMAGE_FILE_RELOCS_STRIPPED           0x0001
</span><span class="c1">// File is executable  (i.e. no unresolved  external references).
</span><span class="cp">#define IMAGE_FILE_EXECUTABLE_IMAGE          0x0002
</span><span class="c1">// Line nunbers stripped from file.
</span><span class="cp">#define IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004
</span><span class="c1">// Local symbols stripped from file.
</span><span class="cp">#define IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008
</span><span class="c1">// Aggressively trim working set
</span><span class="cp">#define IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010
</span><span class="c1">// App can handle &gt;2gb addresses
</span><span class="cp">#define IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020
</span><span class="c1">// Bytes of machine word are reversed.
</span><span class="cp">#define IMAGE_FILE_BYTES_REVERSED_LO         0x0080
</span><span class="c1">// 32 bit word machine.
</span><span class="cp">#define IMAGE_FILE_32BIT_MACHINE             0x0100
</span><span class="c1">// Debugging info stripped from file in .DBG  file
</span><span class="cp">#define IMAGE_FILE_DEBUG_STRIPPED            0x0200
</span><span class="c1">// If Image is on removable media, copy and run from the swap file.
</span><span class="cp">#define IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400
</span><span class="c1">// If Image is on Net, copy and run from the swap file.
</span><span class="cp">#define IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800
#define IMAGE_FILE_SYSTEM                    0x1000  </span><span class="c1">// System File.
</span><span class="cp">#define IMAGE_FILE_DLL                       0x2000  </span><span class="c1">// File is a DLL.
// File should only be run on a UP machine
</span><span class="cp">#define IMAGE_FILE_UP_SYSTEM_ONLY            0x4000
</span><span class="c1">// Bytes of machine word are reversed.
</span><span class="cp">#define IMAGE_FILE_BYTES_REVERSED_HI         0x8000</span></pre></div><div class="step step-level-1 windbg" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="48000" data-y="42000" data-z="0"><h1 id="file-header-pefile-view">File Header pefile View</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">FILE_HEADER</span>
<span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_FILE_HEADER</span><span class="p">]</span> <span class="mh">0xEC</span> <span class="mh">0x0</span> <span class="n">Machine</span><span class="p">:</span> <span class="mh">0x14C</span> <span class="mh">0xEE</span> <span class="mh">0x2</span>
<span class="n">NumberOfSections</span><span class="p">:</span> <span class="mh">0x3</span> <span class="mh">0xF0</span> <span class="mh">0x4</span>
<span class="n">TimeDateStamp</span><span class="p">:</span> <span class="mh">0x5717DB9D</span> <span class="p">[</span><span class="n">Wed</span> <span class="n">Apr</span> <span class="mi">20</span> <span class="mi">19</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">21</span> <span class="mi">2016</span> <span class="n">UTC</span><span class="p">]</span> <span class="mh">0xF4</span> <span class="mh">0x8</span>
<span class="n">PointerToSymbolTable</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0xF8</span> <span class="mh">0xC</span> <span class="n">NumberOfSymbols</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0xFC</span> <span class="mh">0x10</span>
<span class="n">SizeOfOptionalHeader</span><span class="p">:</span> <span class="mh">0xE0</span> <span class="mh">0xFE</span> <span class="mh">0x12</span> <span class="n">Characteristics</span><span class="p">:</span> <span class="mh">0x102</span><span class="o">&gt;</span></pre><p>Some convenient attribute functions:</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">is_exe</span><span class="p">()</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">is_dll</span><span class="p">()</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">is_driver</span><span class="p">()</span>
<span class="bp">False</span>
<span class="o">&gt;&gt;&gt;</span></pre></div><div class="step step-level-1 flex-image" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="50000" data-y="44000" data-z="0"><img src="./img/PE_vis_opthdr.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1 windbg" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="52000" data-y="46000" data-z="0"><h1 id="image-optional-header">Image Optional Header</h1><pre class="highlight code c"><span class="cp">#define IMAGE_NUMBEROF_DIRECTORY_ENTRIES        16
</span>
<span class="c1">//...
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_OPTIONAL_HEADER</span> <span class="p">{</span>
    <span class="n">WORD</span>    <span class="n">Magic</span><span class="p">;</span>
    <span class="n">BYTE</span>    <span class="n">MajorLinkerVersion</span><span class="p">;</span>
    <span class="n">BYTE</span>    <span class="n">MinorLinkerVersion</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfCode</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfInitializedData</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfUninitializedData</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">AddressOfEntryPoint</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">BaseOfCode</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">BaseOfData</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">ImageBase</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SectionAlignment</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">FileAlignment</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MajorOperatingSystemVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MinorOperatingSystemVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MajorImageVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MinorImageVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MajorSubsystemVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MinorSubsystemVersion</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Win32VersionValue</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfImage</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfHeaders</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">CheckSum</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">Subsystem</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">DllCharacteristics</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfStackReserve</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfStackCommit</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfHeapReserve</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfHeapCommit</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">LoaderFlags</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">NumberOfRvaAndSizes</span><span class="p">;</span>
    <span class="n">IMAGE_DATA_DIRECTORY</span> <span class="n">DataDirectory</span><span class="p">[</span><span class="n">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="p">];</span>
<span class="p">}</span> <span class="n">IMAGE_OPTIONAL_HEADER32</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_OPTIONAL_HEADER32</span><span class="p">;</span></pre><p>Defined in winnt.h</p></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="54000" data-y="48000" data-z="0"><h1 id="id1">Image Optional Header</h1><ul><li>As mentioned before, it is not AT ALL optional</li><li><dl><dt>The difference between the 32 and 64 bit versions of this structure (IMAGE_OPTIONAL_HEADER32/IMAGE_OPTIONAL_HEADER64) is that several fields are essentially pointer width; that is, the following are all defined to be ULONGLONG in PE32+:</dt><dd><ul><li>ImageBase</li><li>SizeOfStackReserve</li><li>SizeOfStackCommit</li><li>SizeOfHeapReserve</li><li>SizeOfHeapCommit</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="30" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="56000" data-y="50000" data-z="0"><h1 id="some-interesting-fields">Some Interesting Fields</h1><ul><li>Magic: Additional information about the type of binary (e.g., PE32, PE32+ (x64), or ROM); can be one of the following:</li></ul><pre class="highlight code c"><span class="cp">#define IMAGE_NT_OPTIONAL_HDR32_MAGIC      0x10b
#define IMAGE_NT_OPTIONAL_HDR64_MAGIC      0x20b
#define IMAGE_ROM_OPTIONAL_HDR_MAGIC       0x107</span></pre></div><div class="step step-level-1" step="31" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="58000" data-y="52000" data-z="0"><h1 id="some-interesting-fields-cont-d">Some Interesting Fields (cont'd)</h1><ul><li>SizeOfCode: The combined, rounded-up size of all the code sections. Generally, this matches the size of the .text section.</li><li>AddressOfEntryPoint: This is an RVA indicating where execution should begin once the executable has been loaded. Typically someplace int he .text section.</li></ul></div><div class="step step-level-1" step="32" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="60000" data-y="54000" data-z="0"><h1 id="id2">Some Interesting Fields (cont'd)</h1><ul><li>BaseOfCode: An RVA to the beginning of the code section, relative to the image base.</li><li><dl><dt>ImageBase: The "preferred address" of the image when it gets loaded into memory.</dt><dd><ul><li>According to MSDN, this must be a multiple of 64K.</li><li>PE files are NOT position independent; that is: if they cannot be loaded at their preferred address, sections within the binary must be "fixed up" due to being relocated.</li><li>For DLLs, this value defaults to 0x10000000</li><li>For Applications, this (generally) defaults to 0x00400000</li><li>This may vary with old versions of Windows (or old compilers/toolkits)</li></ul></dd></dl></li></ul></div><div class="step step-level-1 windbg" step="33" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="62000" data-y="56000" data-z="0"><h1 id="id3">Some Interesting Fields (cont'd)</h1><ul><li>SizeOfImage: The total size of the image in bytes (i.e., the amount of space needed to load the image)</li><li>Subsystem: The subsystem that should handle this image. Many options exist, and are defined on MSDN (as well as in winnt.h) but some common options are:</li></ul><pre class="highlight code c"><span class="c1">// Image doesn't require a subsystem (e.g., drivers).
</span><span class="cp">#define IMAGE_SUBSYSTEM_NATIVE       1
</span><span class="c1">// Image runs in the Windows GUI subsystem.
</span><span class="cp">#define IMAGE_SUBSYSTEM_WINDOWS_GUI  2
</span><span class="c1">// Image runs in the Windows character subsystem. (console applications)
</span><span class="cp">#define IMAGE_SUBSYSTEM_WINDOWS_CUI  3</span></pre></div><div class="step step-level-1 windbg" step="34" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="64000" data-y="58000" data-z="0"><h1 id="id4">Some Interesting Fields (cont'd)</h1><ul><li>DllCharacteristics: Some special flags indicating certain attributes of the file. Possible options are documented in the same places as many of the other fields (MSDN, winnt.h) but some interesting options include:</li></ul><pre class="highlight code c"><span class="cp">#define IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE 0x0040 </span><span class="c1">// DLL can move.
</span><span class="cp">#define IMAGE_DLLCHARACTERISTICS_NX_COMPAT    0x0100 </span><span class="c1">// Image is NX compatible
// Image does not use SEH.  No SE handler may reside in this image
</span><span class="cp">#define IMAGE_DLLCHARACTERISTICS_NO_SEH       0x0400
#define IMAGE_DLLCHARACTERISTICS_WDM_DRIVER   0x2000 </span><span class="c1">// Driver uses WDM model
// Image supports Control Flow Guard.
</span><span class="cp">#define IMAGE_DLLCHARACTERISTICS_GUARD_CF     0x4000</span></pre></div><div class="step step-level-1" step="35" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="66000" data-y="60000" data-z="0"><h1 id="id5">Some Interesting Fields (cont'd)</h1><ul><li>NumberOfRvaAndSizes: This (theoretically) could change, but generally ends up being 16. It is intended to indicate the number of entries in the IMAGE_DATA_DIRECTORY array.</li><li>DataDirectory: The beginning of the list of data directories in the binary.</li></ul><div class="notes"><p>Some related mentions: DYNAMIC_BASE refers specifically to ASLR, NX_COMPAT essentially relates to DEP (or data execution prevention), SEH/handlers relate to exception handling, and control flow guard is a feature that is intended to prevent certain types of hooks.</p></div></div><div class="step step-level-1 windbg" step="36" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="68000" data-y="62000" data-z="0"><h1 id="image-directory-entries">Image Directory Entries</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
    <span class="n">DWORD</span>   <span class="n">VirtualAddress</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_DATA_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DATA_DIRECTORY</span><span class="p">;</span>

<span class="c1">// ...
</span>

<span class="cp">#define IMAGE_DIRECTORY_ENTRY_EXPORT          0 </span><span class="c1">// Export Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_IMPORT          1 </span><span class="c1">// Import Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_RESOURCE        2 </span><span class="c1">// Resource Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_EXCEPTION       3 </span><span class="c1">// Exception Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_SECURITY        4 </span><span class="c1">// Security Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_BASERELOC       5 </span><span class="c1">// Base Relocation Table
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_DEBUG           6 </span><span class="c1">// Debug Directory
//      IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7 // (X86 usage)
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7 </span><span class="c1">// Architecture Specific Data
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8 </span><span class="c1">// RVA of GP
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_TLS             9 </span><span class="c1">// TLS Directory
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10 </span><span class="c1">// Load Configuration Dir
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11 </span><span class="c1">// Bound Import Dir in headers
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_IAT            12 </span><span class="c1">// Import Address Table
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13 </span><span class="c1">// Delay Load Import Descr
</span><span class="cp">#define IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14 </span><span class="c1">// COM Runtime descriptor</span></pre><p>Defined in winnt.h</p></div><div class="step step-level-1" step="37" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="70000" data-y="64000" data-z="0"><h1 id="image-directory-entries-cont-d">Image Directory Entries (cont'd)</h1><ul><li>Only 15 (0-14) options are currently defined</li><li>We will talk about many of these sections individually, and what they typically contain when we return to this topic</li></ul></div><div class="step step-level-1 windbg" step="38" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="72000" data-y="66000" data-z="0"><h1 id="image-optional-header-pefile-view">Image Optional Header pefile View</h1><p>As seen below, the Image Directory Entries are actually excluded from the output (as most of them have their own, dedicated sections):</p><pre class="highlight code python"><span class="o">&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">OPTIONAL_HEADER</span>
<span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_OPTIONAL_HEADER</span><span class="p">]</span> <span class="mh">0x100</span> <span class="mh">0x0</span> <span class="n">Magic</span><span class="p">:</span> <span class="mh">0x10B</span> <span class="mh">0x102</span> <span class="mh">0x2</span>
<span class="n">MajorLinkerVersion</span><span class="p">:</span> <span class="mh">0x8</span> <span class="mh">0x103</span> <span class="mh">0x3</span> <span class="n">MinorLinkerVersion</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x104</span> <span class="mh">0x4</span>
<span class="n">SizeOfCode</span><span class="p">:</span> <span class="mh">0x1200</span> <span class="mh">0x108</span> <span class="mh">0x8</span> <span class="n">SizeOfInitializedData</span><span class="p">:</span> <span class="mh">0xC00</span> <span class="mh">0x10C</span> <span class="mh">0xC</span>
<span class="n">SizeOfUninitializedData</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x110</span> <span class="mh">0x10</span> <span class="n">AddressOfEntryPoint</span><span class="p">:</span> <span class="mh">0x14CB</span> <span class="mh">0x114</span> <span class="mh">0x14</span>
<span class="n">BaseOfCode</span><span class="p">:</span> <span class="mh">0x1000</span> <span class="mh">0x118</span> <span class="mh">0x18</span> <span class="n">BaseOfData</span><span class="p">:</span> <span class="mh">0x3000</span> <span class="mh">0x11C</span> <span class="mh">0x1C</span>
<span class="n">ImageBase</span><span class="p">:</span> <span class="mh">0x1000000</span> <span class="mh">0x120</span> <span class="mh">0x20</span> <span class="n">SectionAlignment</span><span class="p">:</span> <span class="mh">0x1000</span> <span class="mh">0x124</span> <span class="mh">0x24</span>
<span class="n">FileAlignment</span><span class="p">:</span> <span class="mh">0x200</span> <span class="mh">0x128</span> <span class="mh">0x28</span> <span class="n">MajorOperatingSystemVersion</span><span class="p">:</span> <span class="mh">0x6</span> <span class="mh">0x12A</span> <span class="mh">0x2A</span>
<span class="n">MinorOperatingSystemVersion</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x12C</span> <span class="mh">0x2C</span> <span class="n">MajorImageVersion</span><span class="p">:</span> <span class="mh">0x6</span> <span class="mh">0x12E</span> <span class="mh">0x2E</span>
<span class="n">MinorImageVersion</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x130</span> <span class="mh">0x30</span> <span class="n">MajorSubsystemVersion</span><span class="p">:</span> <span class="mh">0x5</span> <span class="mh">0x132</span> <span class="mh">0x32</span>
<span class="n">MinorSubsystemVersion</span><span class="p">:</span> <span class="mh">0x1</span> <span class="mh">0x134</span> <span class="mh">0x34</span> <span class="n">Reserved1</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x138</span> <span class="mh">0x38</span>
<span class="n">SizeOfImage</span><span class="p">:</span> <span class="mh">0x5000</span> <span class="mh">0x13C</span> <span class="mh">0x3C</span> <span class="n">SizeOfHeaders</span><span class="p">:</span> <span class="mh">0x400</span> <span class="mh">0x140</span> <span class="mh">0x40</span>
<span class="n">CheckSum</span><span class="p">:</span> <span class="mh">0x9A31</span> <span class="mh">0x144</span> <span class="mh">0x44</span> <span class="n">Subsystem</span><span class="p">:</span> <span class="mh">0x3</span> <span class="mh">0x146</span> <span class="mh">0x46</span>
<span class="n">DllCharacteristics</span><span class="p">:</span> <span class="mh">0x8140</span> <span class="mh">0x148</span> <span class="mh">0x48</span> <span class="n">SizeOfStackReserve</span><span class="p">:</span> <span class="mh">0x40000</span> <span class="mh">0x14C</span> <span class="mh">0x4C</span>
<span class="n">SizeOfStackCommit</span><span class="p">:</span> <span class="mh">0x2000</span> <span class="mh">0x150</span> <span class="mh">0x50</span> <span class="n">SizeOfHeapReserve</span><span class="p">:</span> <span class="mh">0x100000</span> <span class="mh">0x154</span> <span class="mh">0x54</span>
<span class="n">SizeOfHeapCommit</span><span class="p">:</span> <span class="mh">0x1000</span> <span class="mh">0x158</span> <span class="mh">0x58</span> <span class="n">LoaderFlags</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x15C</span> <span class="mh">0x5C</span>
<span class="n">NumberOfRvaAndSizes</span><span class="p">:</span> <span class="mh">0x10</span><span class="o">&gt;</span></pre></div><div class="step step-level-1 flex-image" step="39" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="74000" data-y="68000" data-z="0"><img src="./img/PE_vis_sectbl.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1" step="40" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="76000" data-y="70000" data-z="0"><h1 id="section-table-entries">Section Table Entries</h1><pre class="highlight code c"><span class="cp">#define IMAGE_SIZEOF_SHORT_NAME              8
</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_SECTION_HEADER</span> <span class="p">{</span>
    <span class="n">BYTE</span>    <span class="n">Name</span><span class="p">[</span><span class="n">IMAGE_SIZEOF_SHORT_NAME</span><span class="p">];</span>
    <span class="k">union</span> <span class="p">{</span>
            <span class="n">DWORD</span>   <span class="n">PhysicalAddress</span><span class="p">;</span>
            <span class="n">DWORD</span>   <span class="n">VirtualSize</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">Misc</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">VirtualAddress</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">SizeOfRawData</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">PointerToRawData</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">PointerToRelocations</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">PointerToLinenumbers</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">NumberOfRelocations</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">NumberOfLinenumbers</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Characteristics</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_SECTION_HEADER</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_SECTION_HEADER</span></pre></div><div class="step step-level-1" step="41" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="78000" data-y="72000" data-z="0"><h1 id="section-header">Section Header</h1><ul><li>Name: Fixed-width, but not guaranteed to be NULL-terminated (if the section name is 8 bytes long, for example); indicates the name of the section. Most section begin with a ".", but it is not a requirement.</li><li><dl><dt>Misc: This union means different things to .obj files and regular executables (though, as they are in a union, they both contain the same data):</dt><dd><ul><li>In a standard executable, it contains the actual size of the code or data contained in the section, rounded up for alignment.</li><li>In a .obj file, it contains the actual location of the data in the file (as the SizeOfRawData attribute, later in the structure, indicates the actual data size)</li></ul></dd></dl></li></ul></div><div class="step step-level-1" step="42" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="80000" data-y="74000" data-z="0"><h1 id="section-header-cont-d">Section Header (cont'd)</h1><ul><li>VirtualAddress: RVA relative to the ImageBase element of OptionalHeader</li><li><dl><dt>SizeOfRawData: This is used in a similar fashion to Misc.VirtualSize for executables, but is the definitive size to use for .obj files.</dt><dd><ul><li>Sometimes the VirtualSize may be larger, in the event that the section will need more space allocated</li></ul></dd></dl></li><li>PointerToRawData: The offset into the file where the section data is located</li></ul></div><div class="step step-level-1 windbg" step="43" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="82000" data-y="76000" data-z="0"><h1 id="section-header-characteristics">Section Header Characteristics</h1><ul><li>Indicates information about the section</li><li>Lots of options available (defined in winnt.h), some listed below:</li></ul><pre class="highlight code c"><span class="c1">// Section contains code.
</span><span class="cp">#define IMAGE_SCN_CNT_CODE                   0x00000020
</span><span class="c1">// Section contains initialized data.
</span><span class="cp">#define IMAGE_SCN_CNT_INITIALIZED_DATA       0x00000040
</span><span class="c1">// Section contains uninitialized data.
</span><span class="cp">#define IMAGE_SCN_CNT_UNINITIALIZED_DATA     0x00000080
</span><span class="c1">// Section is not cachable.
</span><span class="cp">#define IMAGE_SCN_MEM_NOT_CACHED             0x04000000
</span><span class="c1">// Section is not pageable.
</span><span class="cp">#define IMAGE_SCN_MEM_NOT_PAGED              0x08000000
</span><span class="c1">// Section is shareable.
</span><span class="cp">#define IMAGE_SCN_MEM_SHARED                 0x10000000
</span><span class="c1">// Section is executable.
</span><span class="cp">#define IMAGE_SCN_MEM_EXECUTE                0x20000000
</span><span class="c1">// Section is readable.
</span><span class="cp">#define IMAGE_SCN_MEM_READ                   0x40000000
</span><span class="c1">// Section is writeable.
</span><span class="cp">#define IMAGE_SCN_MEM_WRITE                  0x80000000</span></pre><div class="notes"><p>Some of these flags will potentionally get ignored, depending on the context of use (e.g., flagging a user mode executable as being "non-pageable")</p></div></div><div class="step step-level-1 windbg" step="44" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="84000" data-y="78000" data-z="0"><h1 id="viewing-sections-via-pefile">Viewing Sections via pefile</h1><p>The following will walk the sections and print some information about each:</p><pre class="highlight code python"><span class="kn">import</span> <span class="nn">pefile</span>

<span class="c1"># ...</span>

<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="s2">"demo.exe"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s2">"{}: Virtual Address: {}, Size of raw data: {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>\
    <span class="nb">hex</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">Misc_VirtualSize</span><span class="p">),</span> <span class="nb">hex</span><span class="p">(</span><span class="n">sec</span><span class="o">.</span><span class="n">SizeOfRawData</span><span class="p">)))</span></pre><p>Addtionally, portions of the sections can be viewed individually:</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span>
<span class="mi">6</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Name</span>
<span class="s1">'.text</span><span class="se">\x00\x00\x00</span><span class="s1">'</span></pre><p>We can also retrieve a portion of a section in this fashion (the first 25 bytes, in this case):</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span><span class="o">.</span><span class="n">sections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()[:</span><span class="mi">25</span><span class="p">]</span>
<span class="s1">'P</span><span class="se">\x1f\x00\x00\x94</span><span class="s1">!</span><span class="se">\x00\x00\x80</span><span class="s1">!</span><span class="se">\x00\x00</span><span class="s1">l!</span><span class="se">\x00\x00</span><span class="s1">R!</span><span class="se">\x00\x00</span><span class="s1">&lt;!</span><span class="se">\x00\x00</span><span class="s1">&amp;'</span></pre><div class="notes"><p>Demo view of section types via IDA Pro</p></div></div><div class="step step-level-1 windbg" step="45" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="86000" data-y="80000" data-z="0"><h1 id="some-common-section-types">Some Common Section Types</h1><ul><li>.text - The typical place executable code ends up</li></ul><pre class="highlight code python"><span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">]</span> <span class="mh">0x1F8</span> <span class="mh">0x0</span> <span class="n">Name</span><span class="p">:</span> <span class="o">.</span><span class="n">text</span> <span class="mh">0x200</span> <span class="mh">0x8</span>
<span class="n">Misc</span><span class="p">:</span> <span class="mh">0x73B19</span> <span class="mh">0x200</span> <span class="mh">0x8</span> <span class="n">Misc_PhysicalAddress</span><span class="p">:</span> <span class="mh">0x73B19</span> <span class="mh">0x200</span> <span class="mh">0x8</span>
<span class="n">Misc_VirtualSize</span><span class="p">:</span> <span class="mh">0x73B19</span> <span class="mh">0x204</span> <span class="mh">0xC</span> <span class="n">VirtualAddress</span><span class="p">:</span> <span class="mh">0x1000</span> <span class="mh">0x208</span> <span class="mh">0x10</span>
<span class="n">SizeOfRawData</span><span class="p">:</span> <span class="mh">0x73C00</span> <span class="mh">0x20C</span> <span class="mh">0x14</span> <span class="n">PointerToRawData</span><span class="p">:</span> <span class="mh">0x400</span> <span class="mh">0x210</span> <span class="mh">0x18</span>
<span class="n">PointerToRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x214</span> <span class="mh">0x1C</span> <span class="n">PointerToLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x218</span> <span class="mh">0x20</span>
<span class="n">NumberOfRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x21A</span> <span class="mh">0x22</span> <span class="n">NumberOfLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x21C</span> <span class="mh">0x24</span>
<span class="n">Characteristics</span><span class="p">:</span> <span class="mh">0x60000020</span><span class="o">&gt;</span></pre><ul><li>.bss - Reserved space for uninitialized data</li><li>.rdata - Read-only data (e.g., strings)</li></ul><pre class="highlight code python"><span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">]</span> <span class="mh">0x220</span> <span class="mh">0x0</span> <span class="n">Name</span><span class="p">:</span> <span class="o">.</span><span class="n">rdata</span> <span class="mh">0x228</span> <span class="mh">0x8</span>
<span class="n">Misc</span><span class="p">:</span> <span class="mh">0x2E3B6</span> <span class="mh">0x228</span> <span class="mh">0x8</span> <span class="n">Misc_PhysicalAddress</span><span class="p">:</span> <span class="mh">0x2E3B6</span> <span class="mh">0x228</span> <span class="mh">0x8</span>
<span class="n">Misc_VirtualSize</span><span class="p">:</span> <span class="mh">0x2E3B6</span> <span class="mh">0x22C</span> <span class="mh">0xC</span> <span class="n">VirtualAddress</span><span class="p">:</span> <span class="mh">0x75000</span> <span class="mh">0x230</span> <span class="mh">0x10</span>
<span class="n">SizeOfRawData</span><span class="p">:</span> <span class="mh">0x2E400</span> <span class="mh">0x234</span> <span class="mh">0x14</span> <span class="n">PointerToRawData</span><span class="p">:</span> <span class="mh">0x74000</span> <span class="mh">0x238</span> <span class="mh">0x18</span>
<span class="n">PointerToRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x23C</span> <span class="mh">0x1C</span> <span class="n">PointerToLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x240</span> <span class="mh">0x20</span>
<span class="n">NumberOfRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x242</span> <span class="mh">0x22</span> <span class="n">NumberOfLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x244</span> <span class="mh">0x24</span>
<span class="n">Characteristics</span><span class="p">:</span> <span class="mh">0x40000040</span><span class="o">&gt;</span></pre></div><div class="step step-level-1 windbg" step="46" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="88000" data-y="82000" data-z="0"><h1 id="some-common-section-types-cont-d">Some Common Section Types (cont'd)</h1><ul><li>.data - Writable data</li><li>.rsrc - Resource Section (more on this later)</li></ul><pre class="highlight code python"><span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">]</span> <span class="mh">0x298</span> <span class="mh">0x0</span> <span class="n">Name</span><span class="p">:</span> <span class="o">.</span><span class="n">rsrc</span> <span class="mh">0x2A0</span> <span class="mh">0x8</span>
<span class="n">Misc</span><span class="p">:</span> <span class="mh">0x528</span> <span class="mh">0x2A0</span> <span class="mh">0x8</span> <span class="n">Misc_PhysicalAddress</span><span class="p">:</span> <span class="mh">0x528</span> <span class="mh">0x2A0</span> <span class="mh">0x8</span>
<span class="n">Misc_VirtualSize</span><span class="p">:</span> <span class="mh">0x528</span> <span class="mh">0x2A4</span> <span class="mh">0xC</span> <span class="n">VirtualAddress</span><span class="p">:</span> <span class="mh">0xAB000</span> <span class="mh">0x2A8</span> <span class="mh">0x10</span>
<span class="n">SizeOfRawData</span><span class="p">:</span> <span class="mh">0x600</span> <span class="mh">0x2AC</span> <span class="mh">0x14</span> <span class="n">PointerToRawData</span><span class="p">:</span> <span class="mh">0xA8000</span> <span class="mh">0x2B0</span> <span class="mh">0x18</span>
<span class="n">PointerToRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2B4</span> <span class="mh">0x1C</span> <span class="n">PointerToLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2B8</span> <span class="mh">0x20</span>
<span class="n">NumberOfRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2BA</span> <span class="mh">0x22</span> <span class="n">NumberOfLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2BC</span> <span class="mh">0x24</span>
<span class="n">Characteristics</span><span class="p">:</span> <span class="mh">0x40000040</span><span class="o">&gt;</span></pre><ul><li>.reloc - Relocation info</li></ul><pre class="highlight code python"><span class="o">&lt;</span><span class="n">Structure</span><span class="p">:</span> <span class="p">[</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">]</span> <span class="mh">0x2C0</span> <span class="mh">0x0</span> <span class="n">Name</span><span class="p">:</span> <span class="o">.</span><span class="n">reloc</span> <span class="mh">0x2C8</span> <span class="mh">0x8</span>
<span class="n">Misc</span><span class="p">:</span> <span class="mh">0x238</span> <span class="mh">0x2C8</span> <span class="mh">0x8</span> <span class="n">Misc_PhysicalAddress</span><span class="p">:</span> <span class="mh">0x238</span> <span class="mh">0x2C8</span> <span class="mh">0x8</span>
<span class="n">Misc_VirtualSize</span><span class="p">:</span> <span class="mh">0x238</span> <span class="mh">0x2CC</span> <span class="mh">0xC</span> <span class="n">VirtualAddress</span><span class="p">:</span> <span class="mh">0xAC000</span> <span class="mh">0x2D0</span> <span class="mh">0x10</span>
<span class="n">SizeOfRawData</span><span class="p">:</span> <span class="mh">0x400</span> <span class="mh">0x2D4</span> <span class="mh">0x14</span> <span class="n">PointerToRawData</span><span class="p">:</span> <span class="mh">0xA8600</span> <span class="mh">0x2D8</span> <span class="mh">0x18</span>
<span class="n">PointerToRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2DC</span> <span class="mh">0x1C</span> <span class="n">PointerToLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2E0</span> <span class="mh">0x20</span>
<span class="n">NumberOfRelocations</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2E2</span> <span class="mh">0x22</span> <span class="n">NumberOfLinenumbers</span><span class="p">:</span> <span class="mh">0x0</span> <span class="mh">0x2E4</span> <span class="mh">0x24</span>
<span class="n">Characteristics</span><span class="p">:</span> <span class="mh">0x42000040</span><span class="o">&gt;</span></pre></div><div class="step step-level-1 flex-image" step="47" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="90000" data-y="84000" data-z="0"><img src="./img/PE_vis_imports.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1 windbg" step="48" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="92000" data-y="86000" data-z="0"><h1 id="image-imports">Image Imports</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_DATA_DIRECTORY</span> <span class="p">{</span>
    <span class="n">DWORD</span>   <span class="n">VirtualAddress</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_DATA_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_DATA_DIRECTORY</span><span class="p">;</span>

<span class="cm">/* ... */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_IMPORT_DESCRIPTOR</span> <span class="p">{</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">DWORD</span>   <span class="n">Characteristics</span><span class="p">;</span>    <span class="c1">// 0 for terminating null import descriptor
</span>     <span class="c1">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)
</span>    <span class="n">DWORD</span>   <span class="n">OriginalFirstThunk</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
  <span class="n">DWORD</span>   <span class="n">TimeDateStamp</span><span class="p">;</span>  <span class="c1">// 0 if not bound,
</span>                          <span class="c1">// -1 if bound, and real date\time stamp
</span>                          <span class="c1">// in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)
</span>                          <span class="c1">// O.W. date/time stamp of DLL bound to (Old BIND)
</span>
  <span class="n">DWORD</span>   <span class="n">ForwarderChain</span><span class="p">;</span> <span class="c1">// -1 if no forwarders
</span>  <span class="n">DWORD</span>   <span class="n">Name</span><span class="p">;</span>
  <span class="n">DWORD</span>   <span class="n">FirstThunk</span><span class="p">;</span>  <span class="c1">// RVA to IAT (if bound this IAT has actual addresses)
</span><span class="p">}</span> <span class="n">IMAGE_IMPORT_DESCRIPTOR</span><span class="p">;</span></pre><p>Defined: winnt.h</p></div><div class="step step-level-1" step="49" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="94000" data-y="88000" data-z="0"><h1 id="image-import-descriptor">Image Import Descriptor</h1><ul><li>OriginalFirstThunk: This element contains an RVA to the Import Name Table (INT), which is a list of IMAGE_THUNK_DATA unions (we'll discuss this structure more next slide)</li><li>ForwardedChain: If not set to -1 (or in this case: 0xffffffff), it contains an index into the FirstThunk array (more on this field later), which allows a DLL to forward calls to an exported function to a function exported by another DLL.</li></ul></div><div class="step step-level-1" step="50" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="96000" data-y="90000" data-z="0"><h1 id="image-import-descriptor-cont-d">Image Import Descriptor (cont'd)</h1><ul><li>Name: An RVA to a NULL-terminated ASCII string containing the module name</li><li><dl><dt>FirstThunk: Another RVA to an array of IMAGE_THUNK_DATA unions. This list, however, is the actual Import Address Table (IAT), rather than the INT pointed to by the OriginalFirstThunk.</dt><dd><ul><li>This list (the IAT) actually gets overwritten by the loader with the actual (virtual) addresses we're trying to reach</li></ul></dd></dl></li><li>As we'll see soon, the INT and IAT work together to model the list of imports</li></ul></div><div class="step step-level-1" step="51" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="98000" data-y="92000" data-z="0"><h1 id="import-tables">Import Tables</h1><ul><li>While only IMAGE_THUNK_DATA32 is listed below, IMAGE_THUNK_DATA64 contains the same field names, but is instead of size ULONGLONG.</li></ul><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_IMPORT_BY_NAME</span> <span class="p">{</span>
    <span class="n">WORD</span>    <span class="n">Hint</span><span class="p">;</span>
    <span class="n">CHAR</span>   <span class="n">Name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">IMAGE_IMPORT_BY_NAME</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_IMPORT_BY_NAME</span><span class="p">;</span>

<span class="cm">/* ... */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_THUNK_DATA32</span> <span class="p">{</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="n">DWORD</span> <span class="n">ForwarderString</span><span class="p">;</span>      <span class="c1">// PBYTE
</span>        <span class="n">DWORD</span> <span class="n">Function</span><span class="p">;</span>             <span class="c1">// PDWORD
</span>        <span class="n">DWORD</span> <span class="n">Ordinal</span><span class="p">;</span>
        <span class="n">DWORD</span> <span class="n">AddressOfData</span><span class="p">;</span>        <span class="c1">// PIMAGE_IMPORT_BY_NAME
</span>    <span class="p">}</span> <span class="n">u1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">IMAGE_THUNK_DATA32</span><span class="p">;</span></pre><p>Defined: winnt.h</p></div><div class="step step-level-1" step="52" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="100000" data-y="94000" data-z="0"><h1 id="import-tables-cont-d">Import Tables (cont'd)</h1><ul><li><dl><dt>IAT/INT both initially point to the same thing; that is: an IMAGE_IMPORT_BY_NAME structure, which contains some combination of the ordinal of the function we want to import and/or a NULL-terminated ASCII string indicating the function's exported name.</dt><dd><ul><li>The Hint is the ordinal of the function to import</li><li>The Name (which, if populated, will never be just a byte), the NULL-terminated name of the function.</li></ul></dd></dl></li></ul><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_IMPORT_BY_NAME</span> <span class="p">{</span>
    <span class="n">WORD</span>    <span class="n">Hint</span><span class="p">;</span>
    <span class="n">CHAR</span>   <span class="n">Name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">IMAGE_IMPORT_BY_NAME</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_IMPORT_BY_NAME</span><span class="p">;</span></pre><ul><li>As mentioned before, during the loading process, the IAT's entries get overwritten with the addresses of the imported functions we are trying to reach.</li></ul></div><div class="step step-level-1" step="53" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="102000" data-y="96000" data-z="0"><h1 id="initial">Initial</h1><img src="./img/PE_import_view_initial_p2.png"></img></div><div class="step step-level-1" step="54" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="104000" data-y="98000" data-z="0"><h1 id="post-load">Post-Load</h1><img src="./img/PE_import_view_after.png"></img></div><div class="step step-level-1 windbg" step="55" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="106000" data-y="100000" data-z="0"><h1 id="listing-imports">Listing Imports</h1><ul><li>Dumping imports via pefile is quite easy</li></ul><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">imps</span> <span class="o">=</span> <span class="p">{</span> <span class="n">entry</span><span class="o">.</span><span class="n">dll</span> <span class="p">:</span>\
 <span class="p">[</span> <span class="n">imp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">imports</span> <span class="p">]</span>\
  <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">DIRECTORY_ENTRY_IMPORT</span> <span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">imps</span>
<span class="p">{</span><span class="s1">'KERNEL32.dll'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'GetLastError'</span><span class="p">,</span> <span class="s1">'UnhandledExceptionFilter'</span><span class="p">,</span>
 <span class="s1">'GetCurrentProcess'</span><span class="p">,</span> <span class="s1">'TerminateProcess'</span><span class="p">,</span>
 <span class="s1">'GetSystemTimeAsFileTime'</span><span class="p">,</span> <span class="s1">'GetCurrentProcessId'</span><span class="p">,</span>
 <span class="s1">'GetCurrentThreadId'</span><span class="p">,</span> <span class="s1">'GetTickCount'</span><span class="p">,</span>
 <span class="s1">'QueryPerformanceCounter'</span><span class="p">,</span> <span class="s1">'GetModuleHandleA'</span><span class="p">,</span>
 <span class="s1">'SetUnhandledExceptionFilter'</span><span class="p">,</span> <span class="s1">'RtlUnwind'</span><span class="p">,</span>
 <span class="s1">'InterlockedCompareExchange'</span><span class="p">,</span> <span class="s1">'Sleep'</span><span class="p">,</span> <span class="s1">'InterlockedExchange'</span><span class="p">],</span>
 <span class="s1">'msvcrt.dll'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'_exit'</span><span class="p">,</span> <span class="s1">'_XcptFilter'</span><span class="p">,</span>
 <span class="s1">'exit'</span><span class="p">,</span> <span class="s1">'_initterm'</span><span class="p">,</span> <span class="s1">'_amsg_exit'</span><span class="p">,</span> <span class="s1">'__setusermatherr'</span><span class="p">,</span>
 <span class="s1">'_adjust_fdiv'</span><span class="p">,</span> <span class="s1">'__p__commode'</span><span class="p">,</span> <span class="s1">'__p__fmode'</span><span class="p">,</span>
 <span class="s1">'__set_app_type'</span><span class="p">,</span> <span class="s1">'?terminate@@YAXXZ'</span><span class="p">,</span> <span class="s1">'_controlfp'</span><span class="p">,</span> <span class="s1">'_cexit'</span><span class="p">,</span>
 <span class="s1">'__getmainargs'</span><span class="p">,</span> <span class="s1">'fopen'</span><span class="p">,</span> <span class="s1">'printf'</span><span class="p">,</span> <span class="s1">'fprintf'</span><span class="p">,</span>
 <span class="s1">'fclose'</span><span class="p">],</span> <span class="s1">'USER32.dll'</span><span class="p">:</span> <span class="p">[</span><span class="s1">'MessageBoxA'</span><span class="p">]}</span></pre></div><div class="step step-level-1 flex-image" step="56" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="108000" data-y="102000" data-z="0"><h1 id="listing-imports-cont-d">Listing Imports (cont'd)</h1><ul><li>Also easily viewable through IDA:</li></ul><img src="./img/PE_IDA_import_v.png"></img></div><div class="step step-level-1 flex-image" step="57" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="110000" data-y="104000" data-z="0"><img src="./img/PE_vis_exports.png"></img><p>Original Image Credit: Ero Carrera</p></div><div class="step step-level-1" step="58" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="112000" data-y="106000" data-z="0"><h1 id="exports">Exports</h1><pre class="highlight code c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_IMAGE_EXPORT_DIRECTORY</span> <span class="p">{</span>
    <span class="n">DWORD</span>   <span class="n">Characteristics</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">TimeDateStamp</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MajorVersion</span><span class="p">;</span>
    <span class="n">WORD</span>    <span class="n">MinorVersion</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Name</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">Base</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">NumberOfFunctions</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">NumberOfNames</span><span class="p">;</span>
    <span class="n">DWORD</span>   <span class="n">AddressOfFunctions</span><span class="p">;</span>     <span class="c1">// RVA from base of image
</span>    <span class="n">DWORD</span>   <span class="n">AddressOfNames</span><span class="p">;</span>         <span class="c1">// RVA from base of image
</span>    <span class="n">DWORD</span>   <span class="n">AddressOfNameOrdinals</span><span class="p">;</span>  <span class="c1">// RVA from base of image
</span><span class="p">}</span> <span class="n">IMAGE_EXPORT_DIRECTORY</span><span class="p">,</span> <span class="o">*</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">;</span></pre></div><div class="step step-level-1" step="59" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="114000" data-y="108000" data-z="0"><h1 id="looking-at-exports">Looking at Exports</h1><ul><li><dl><dt>Base: This is the number that will need to be subtracted from an ordinal to get a usable (0) index into the AddressOfFunctions Array.</dt><dd><ul><li>Usually defaults to 1, as ordinals start at 1 (by default)</li><li>Note that this may not always be the case (ordinals don't *have* to start at 1)</li></ul></dd></dl></li><li><dl><dt>NumberOfFunctions: This indicates the number of functions that will be exported (e.g., the number of functions in the AddressOfFunctions array)</dt><dd><ul><li>This number may differ from the NumberOfNames field (below), as functions exported by ordinal won't be listed there</li></ul></dd></dl></li><li>NumberOfNames: The number of functions exported by name (also, the number of names in the array pointed to by AddressOfNames)</li></ul></div><div class="step step-level-1" step="60" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="116000" data-y="110000" data-z="0"><h1 id="looking-at-exports-cont-d">Looking at Exports (cont'd)</h1><ul><li>AddressOfFunctions: An RVA to an array of DWORD RVAs to the actual functions being exported. As mentioned above, it will be NumberOfFunctions long. This is also referred to as the Export Address Table (EAT).</li><li>AddressOfNames: An RVA to an array of DWORD RVAs which point to the names of the functions being exported. They will be NumberOfNames in length.</li><li>AddressOfNameOrdinals: An RVA to a table of offsets. The offsets contained here are actually indexes into the AddressOfFunctions array (thus: the function ordinals). They have already been adjusted relative to base.</li></ul></div><div class="step step-level-1" step="61" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="118000" data-y="112000" data-z="0"><h1 id="correlating-names-to-ordinals">Correlating Names to Ordinals</h1><ul><li>If a function is exported by name, the offset into the AddressOfFunctions array must be found in order to locate it</li><li>This offset is stored in the AddressOfNameOrdinals table, at the same location as the corresponding name.</li></ul></div><div class="step step-level-1 windbg" step="62" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="120000" data-y="114000" data-z="0"><h1 id="viewing-exports">Viewing Exports</h1><ul><li>As with imports, we can easily view the list of exports in a binary via pefile:</li></ul><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pefile</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="s2">"sqlite3.dll"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exports</span> <span class="o">=</span> <span class="p">[(</span><span class="n">exp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">ordinal</span><span class="p">)</span>\
 <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">pe</span><span class="o">.</span><span class="n">DIRECTORY_ENTRY_EXPORT</span><span class="o">.</span><span class="n">symbols</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exports</span>
<span class="p">[(</span><span class="s1">'sqlite3_aggregate_context'</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_aggregate_count'</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_auto_extension'</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_backup_finish'</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_backup_init'</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_backup_pagecount'</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_backup_remaining'</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_backup_step'</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_blob'</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_double'</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_int'</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_int64'</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_null'</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_parameter_count'</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_parameter_index'</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_parameter_name'</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_text'</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_text16'</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_bind_value'</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_bind_zeroblob'</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_blob_bytes'</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_blob_close'</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_blob_open'</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_blob_read'</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_blob_write'</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_busy_handler'</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_busy_timeout'</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_changes'</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_clear_bindings'</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_close'</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="s1">'sqlite3_collation_needed'</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="p">(</span><span class="s1">'sqlite3_collation_needed16'</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="o">...</span></pre></div><div class="step step-level-1 flex-image" step="63" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="122000" data-y="116000" data-z="0"><h1 id="viewing-exports-cont-d">Viewing Exports (cont'd)</h1><ul><li>Again, as with imports, exports are also easily viewable via IDA:</li></ul><img src="./img/PE_IDA_export_v.png"></img></div><div class="step step-level-1" step="64" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="124000" data-y="118000" data-z="0"><h1 id="more-pefile-tricks">More pefile Tricks</h1><ul><li>PEFile can additionally be used to read and modify data within a file</li><li>Access RVA values via get_*_from_rva(...)</li><li>Modify via set_*_at_rva(...)</li></ul><p>Example:</p><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pefile</span><span class="o">.</span><span class="n">PE</span><span class="p">(</span><span class="s2">"REDll.dll"</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">get_string_from_rva</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">DIRECTORY_ENTRY_EXPORT</span><span class="o">.</span><span class="n">struct</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
<span class="s1">'REDll.dll'</span></pre></div><div class="step step-level-1" step="65" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="126000" data-y="120000" data-z="0"><h1 id="pefile-lab">PEFile Lab</h1><ul><li>Write a Python script using PEFile to enumerate all imports and exports from Kernel32.dll, KernelBase.dll, and ntdll.dll, and store the results in a text file.</li><li>Additionally, enumerate the sections in each of those files.</li></ul></div><div class="step step-level-1" step="66" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="128000" data-y="122000" data-z="0"><h1 id="additional-resources">Additional Resources</h1><ul><li>Peering Inside the PE, a (slightly outdated) blog post by Matt Pietrek (<a href="https://msdn.microsoft.com/en-us/library/ms809762.aspx">https://msdn.microsoft.com/en-us/library/ms809762.aspx</a>)</li><li>pefile examples (from the pefile repo on github: <a href="https://github.com/erocarrera/pefile/blob/wiki/UsageExamples.md#introduction">https://github.com/erocarrera/pefile/blob/wiki/UsageExamples.md#introduction</a>)</li><li>The Life of Binaries course by Xeno Kovah (<a href="http://opensecuritytraining.info/LifeOfBinaries.html">http://opensecuritytraining.info/LifeOfBinaries.html</a>)</li></ul></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>